function onOpen() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetMain = ss.getSheetByName("Main");
  var sheetMunicipios = ss.getSheetByName("Municipios");

  function onEdit(e) {
  var sheet = e.range.getSheet();
  var abaMain = "Main";
  var celulaEstado = "D11";
  var celulaCidade = "D16";

  // Verifica se estamos na aba e célula corretas
  if (sheet.getName() === abaMain && e.range.getA1Notation() === celulaEstado) {
    var estadoSelecionado = e.range.getValue();
    var planilhaMunicipios = e.source.getSheetByName("Municipios");

    if (!estadoSelecionado) {
      sheet.getRange(celulaCidade).clearDataValidations().clearContent();
      return;
    }

    // Pega dados da aba Municipios (A = Estado, F = Município)
    var ultimaLinha = planilhaMunicipios.getLastRow();
    var dados = planilhaMunicipios.getRange("A2:F" + ultimaLinha).getValues();
    var cidades = [];

    dados.forEach(function(linha) {
      if (linha[0] === estadoSelecionado && linha[5]) {
        cidades.push(linha[5]); // Coluna F
      }
    });

    var destino = sheet.getRange(celulaCidade);

    if (cidades.length > 0) {
      var regraCidade = SpreadsheetApp.newDataValidation()
        .requireValueInList(cidades.sort(), true)
        .setAllowInvalid(false)
        .build();
      destino.clearContent().setDataValidation(regraCidade);
    } else {
      destino.clearDataValidations().clearContent();
    }
  }
  }
}
