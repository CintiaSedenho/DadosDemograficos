function onOpen() {
  SpreadsheetApp.getUi().createMenu('Estados')
    .addItem('Atualizar', 'onEdit')
    .addToUi();
}

const estados = {
  "Acre": "AC", "Alagoas": "AL", "Amapá": "AP", "Amazonas": "AM", "Bahia": "BA",
  "Ceará": "CE", "Distrito Federal": "DF", "Espírito Santo": "ES", "Goiás": "GO",
  "Maranhão": "MA", "Mato Grosso": "MT", "Mato Grosso do Sul": "MS", "Minas Gerais": "MG",
  "Pará": "PA", "Paraíba": "PB", "Paraná": "PR", "Pernambuco": "PE", "Piauí": "PI",
  "Rio de Janeiro": "RJ", "Rio Grande do Norte": "RN", "Rio Grande do Sul": "RS",
  "Rondônia": "RO", "Roraima": "RR", "Santa Catarina": "SC", "São Paulo": "SP",
  "Sergipe": "SE", "Tocantins": "TO"
};

function onEdit(e) {
  var sheet = e.range.getSheet();
  var celulaEstado = "D11";
  var celulaCidade = "D16";

  if (sheet.getName() === "Main" && e.range.getA1Notation() === celulaEstado) {
    var estadoSelecionado = e.range.getValue().trim();
    var sigla = estados[estadoSelecionado];
    var destino = sheet.getRange(celulaCidade);
    var cidades = getCitiesFromMunicipios(sigla);

    if (cidades.length > 0) {
      var auxSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Aux");
      if (!auxSheet) {
        auxSheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet("Aux");
      }

      auxSheet.clear(); // Limpa dados antigos

      // Escreve as cidades na coluna A da aba Aux
      for (var i = 0; i < cidades.length; i++) {
        auxSheet.getRange(i + 1, 1).setValue(cidades[i]);
      }

      // Define o intervalo de validação (A1:A{n})
      var rangeValidacao = auxSheet.getRange(1, 1, cidades.length, 1);
      var regraCidade = SpreadsheetApp.newDataValidation()
        .requireValueInRange(rangeValidacao, true)
        .setAllowInvalid(false)
        .build();

      destino.clearContent().setDataValidation(regraCidade);
    } else {
      destino.clearDataValidations().clearContent();
    }
  }
}

function getCitiesFromMunicipios(sigla) {
  var planilha = SpreadsheetApp.getActiveSpreadsheet();
  var abaMunicipios = planilha.getSheetByName("MUNICIPIOS");
  var dados = abaMunicipios.getDataRange().getValues();
  var cidades = [];

  for (var i = 1; i < dados.length; i++) { // pula o cabeçalho
    var siglaEstado = dados[i][2]; // Coluna C → índice 2
    var nomeCidade = dados[i][3]; // Coluna D → índice 3

    if (siglaEstado === sigla && nomeCidade) {
      cidades.push(nomeCidade.toString().trim());
    }
  }

  return cidades;
}


  return cidades;
}
